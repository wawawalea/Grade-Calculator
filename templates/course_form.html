{% extends "base.html" %}

{% block title %}{{ course_name }} - Grade Calculator{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <h2 style="color: #333; margin: 0;">{{ course_name }}</h2>
    {% if is_custom %}
    <div style="display: flex; gap: 10px;">
        <a href="{{ url_for('create_course', edit=course_name) }}" class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.9em;">
            ‚úèÔ∏è Edit Course
        </a>
        <button onclick="deleteCourse('{{ course_name }}')" class="btn btn-secondary" style="padding: 8px 15px; font-size: 0.9em; background: #dc3545;">
            üóëÔ∏è Delete
        </button>
    </div>
    {% endif %}
</div>
<p style="color: #666; margin-bottom: 30px;">Enter your scores for each category:</p>

<form id="gradeForm">
    <input type="hidden" name="course_name" value="{{ course_name }}">
    
    {% for category in config.categories %}
    <div class="form-group">
        <label>{{ category.name }} (Max: {{ category.max_score }} points)</label>
        <div class="score-inputs">
            {% for i in range(category.item_count) %}
            <input 
                type="number" 
                step="0.01" 
                min="0" 
                name="{{ category.name }}_{{ i }}"
                placeholder="Item {{ i + 1 }}"
                id="{{ category.name }}_{{ i }}"
            >
            {% endfor %}
        </div>
    </div>
    {% endfor %}
    
    <div style="margin-top: 30px; text-align: center;">
        <button type="submit" class="btn" style="font-size: 1.1em; padding: 15px 40px;">
            Calculate Grades
        </button>
        <a href="{{ url_for('index') }}" class="btn btn-secondary" style="margin-left: 10px;">
            Back to Courses
        </a>
    </div>
</form>

<script>
document.getElementById('gradeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    // Convert FormData to proper object
    const formDataObj = {};
    for (let [key, value] of formData.entries()) {
        if (key === 'course_name') {
            formDataObj[key] = value;
        } else {
            formDataObj[key] = value;
        }
    }
    
    // Submit via fetch to calculate endpoint
    fetch('/calculate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formDataObj)
    })
    .then(response => response.text())
    .then(html => {
        document.body.innerHTML = html;
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
});
</script>

{% if is_custom %}
<script>
function deleteCourse(courseName) {
    if (confirm(`Are you sure you want to delete "${courseName}"? This cannot be undone.`)) {
        fetch(`/delete-course/${encodeURIComponent(courseName)}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                window.location.href = '/';
            } else {
                alert(result.error || 'An error occurred');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
}
</script>
{% endif %}
{% endblock %}
